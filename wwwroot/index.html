<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>VoiceBridge - Canlƒ± √áeviri ve Ses</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      background: #f4f7f6;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }

    #results {
      border-top: 2px solid #eee;
      padding-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .utterance {
      margin-bottom: 15px;
      padding: 10px;
      border-left: 4px solid #007bff;
      background: #f8f9fa;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-start {
      background: #28a745;
      color: white;
    }

    .btn-stop {
      background: #dc3545;
      color: white;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .status {
      font-size: 0.9em;
      color: #666;
    }
  </style>
</head>

<body>

  <div class="container">
    <h2>VoiceBridge Canlƒ± √áeviri</h2>

    <div class="controls">
      <button id="btnStart" class="btn btn-start">üéôÔ∏è Konu≈ümaya Ba≈üla</button>
      <button id="btnStop" class="btn btn-stop" disabled>üõë Durdur</button>
      <label>
        <input type="checkbox" id="chkMute"> Sesi Kapat (Mute)
      </label>
    </div>

    <div id="status" class="status">Sistem hazƒ±r.</div>
    <div id="results"></div>
  </div>

  <script type="module">
    import audioService from './AudioService.js'; // Senin g√∂nderdiƒüin AudioService

    const connection = new signalR.HubConnectionBuilder()
      .withUrl("/hubs/voice", {
        accessTokenFactory: "",
      })
      .withAutomaticReconnect()
      .build();

    // --- 1. Ses √áalma Mantƒ±ƒüƒ± (Queue System) ---
    // Gelen ses par√ßalarƒ±nƒ± sƒ±rayla √ßalmak i√ßin bir kuyruk yapƒ±sƒ±
    let audioQueue = [];
    let isPlaying = false;

    connection.on("ReceiveAudio", (base64Audio) => {
      // Backend'den gelen Base64 sesi kuyruƒüa ekle
      audioQueue.push(base64Audio);
      if (!isPlaying) {
        playNextInQueue();
      }
    });

    async function playNextInQueue() {
      if (audioQueue.length === 0) {
        isPlaying = false;
        return;
      }

      isPlaying = true;
      const base64 = audioQueue.shift();

      // Senin AudioService i√ßindeki playAudioBlob mantƒ±ƒüƒ±nƒ± kullanƒ±yoruz
      // Ancak takƒ±lma olmamasƒ± i√ßin her par√ßayƒ± yeni bir Audio nesnesiyle √ßalƒ±yoruz
      const bytes = base64ToUint8Array(base64);
      const blob = new Blob([bytes], { type: "audio/wav" });
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);

      audio.onended = () => {
        URL.revokeObjectURL(url);
        playNextInQueue(); // Par√ßa bittiƒüinde sonrakine ge√ß
      };

      await audio.play().catch(err => console.error("Oynatma hatasƒ±:", err));
    }

    function base64ToUint8Array(base64) {
      const binaryString = window.atob(base64);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes;
    }

    // --- 2. Metin √áevirilerini Ekrana Basma ---
    connection.on("ReceiveUtterance", (data) => {
      const resultsDiv = document.getElementById("results");
      const div = document.createElement("div");
      div.className = "utterance";
      div.innerHTML = `<strong>Siz:</strong> ${data.originalText}<br>
                         <strong style="color:#007bff">√áeviri:</strong> ${data.translatedText}`;
      resultsDiv.prepend(div);
    });

    // --- 3. Ba≈ülat/Durdur ---
    document.getElementById("btnStart").onclick = async () => {
      const isMuted = document.getElementById("chkMute").checked;

      try {
        await connection.start();

        // Backend'e "Oturumu Ba≈ülat" diyoruz
        await connection.invoke("StartSection", {
          SessionId: null, // Yeni session
          SourceLanguage: "tr-TR",
          TargetLanguage: "en-US",
          IsMuted: isMuted
        });

        // Mikrofonu a√ß ve ham byte array'i g√∂nder (Base64'e √ßevirerek)
        await audioService.startRecording((base64Data) => {
          connection.invoke("SendAudio", base64Data);
        });

        document.getElementById("btnStart").disabled = true;
        document.getElementById("btnStop").disabled = false;
        document.getElementById("status").innerText = "üéôÔ∏è Kayƒ±t ve √ßeviri aktif...";
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "Hata: " + err.message;
      }
    };

    document.getElementById("btnStop").onclick = async () => {
      audioService.stopRecording();
      await connection.stop();
      document.getElementById("btnStart").disabled = false;
      document.getElementById("btnStop").disabled = true;
      document.getElementById("status").innerText = "Sistem durduruldu.";
    };
  </script>
</body>

</html>