<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>VoiceBridge Real-Time Test</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      line-height: 1.6;
    }

    #results {
      border: 2px solid #eee;
      padding: 15px;
      border-radius: 8px;
      min-height: 150px;
      background: #fdfdfd;
    }

    .status {
      font-weight: bold;
      margin-bottom: 10px;
    }

    .btn {
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      color: white;
    }

    #btnStart {
      background-color: #28a745;
    }

    #btnStop {
      background-color: #dc3545;
    }

    .btn:disabled {
      background-color: #ccc;
    }
  </style>
</head>

<body>

  <h2>VoiceBridge CanlÄ± Ã‡eviri Testi</h2>
  <div id="status" class="status">Durum: BaÄŸlanÄ±yor...</div>

  <button id="btnStart" class="btn">Mikrofonu BaÅŸlat</button>
  <button id="btnStop" class="btn" disabled>Durdur</button>

  <h3>Ã‡eviri AkÄ±ÅŸÄ±:</h3>
  <div id="results"></div>

  <script type="module">
    // --- 1. AudioService MantÄ±ÄŸÄ± (Senin gÃ¶nderdiÄŸin mantÄ±kla optimize edildi) ---
    class AudioService {
      constructor() {
        this.audioContext = null;
        this.scriptProcessor = null;
        this.microphoneStream = null;
      }

      async start(onAudioCallback) {
        this.audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
        this.microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        const source = this.audioContext.createMediaStreamSource(this.microphoneStream);

        // 4096 buffer size, 1 kanal giriÅŸ, 1 kanal Ã§Ä±kÄ±ÅŸ
        this.scriptProcessor = this.audioContext.createScriptProcessor(4096, 1, 1);

        source.connect(this.scriptProcessor);
        this.scriptProcessor.connect(this.audioContext.destination);

        function arrayBufferToBase64(buffer) {
          let binary = '';
          const bytes = new Uint8Array(buffer);
          const len = bytes.byteLength;
          for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
          }
          return window.btoa(binary);
        }

        this.scriptProcessor.onaudioprocess = (e) => {
          const inputData = e.inputBuffer.getChannelData(0);
          const pcm16 = this.floatTo16BitPCM(inputData); // Senin Int16 Ã§eviricin

          // 1. PCM Buffer'Ä± Base64 String'e Ã§evir
          const base64String = arrayBufferToBase64(pcm16.buffer);

          // 2. String olarak Hub'a bas
          connection.invoke("SendAudio", base64String);
        };
      }

      floatTo16BitPCM(input) {
        let i = input.length;
        let output = new Int16Array(i);
        while (i--) {
          let s = Math.max(-1, Math.min(1, input[i]));
          output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
        return output;
      }

      stop() {
        if (this.microphoneStream) {
          this.microphoneStream.getTracks().forEach(t => t.stop());
        }
        if (this.scriptProcessor) {
          this.scriptProcessor.disconnect();
        }
      }
    }

    const audioSvc = new AudioService();

    // --- 2. SignalR BaÄŸlantÄ±sÄ± ---
    const connection = new signalR.HubConnectionBuilder()
      .withUrl("/hubs/voice") // Backend endpoint'in
      .withAutomaticReconnect()
      .build();

    connection.on("ReceiveUtterance", (data) => {
      const div = document.createElement("div");
      div.innerHTML = `<p><strong>Orijinal:</strong> ${data.originalText} <br> 
                             <strong>Ã‡eviri:</strong> <span style="color:blue">${data.translatedText}</span></p><hr>`;
      document.getElementById("results").prepend(div);
    });

    connection.start().then(() => {
      document.getElementById("status").innerText = "Durum: BaÄŸlantÄ± HazÄ±r âœ…";
    }).catch(err => {
      document.getElementById("status").innerText = "Hata: " + err.message;
    });

    // --- 3. Buton Kontrolleri ---
    document.getElementById("btnStart").onclick = async () => {
      try {
        // Section'Ä± baÅŸlatÄ±yoruz (SessionId null -> otomatik oluÅŸturur)
        await connection.invoke("StartSection", {
          SessionId: null,
          SourceLanguage: "tr-TR",
          TargetLanguage: "en-US"
        });

        // Mikrofonu aÃ§ ve gelen her paketi gÃ¶nder
        await audioSvc.start((byteArray) => {
          connection.invoke("SendAudio", byteArray);
        });

        document.getElementById("btnStart").disabled = true;
        document.getElementById("btnStop").disabled = false;
        document.getElementById("status").innerText = "Durum: KayÄ±t YapÄ±lÄ±yor... ðŸŽ™ï¸";
      } catch (err) {
        console.error(err);
        alert("BaÅŸlatÄ±lamadÄ±: " + err.message);
      }
    };

    document.getElementById("btnStop").onclick = () => {
      audioSvc.stop();
      connection.stop();
      document.getElementById("btnStart").disabled = false;
      document.getElementById("btnStop").disabled = true;
      document.getElementById("status").innerText = "Durum: Durduruldu. SayfayÄ± yenileyin.";
    };
  </script>
</body>

</html>